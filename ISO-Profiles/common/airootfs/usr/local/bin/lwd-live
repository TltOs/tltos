#!/bin/bash
# driver=free or driver=nonfree - grub and efi
echo "Preparing LWD..."
kernel_cmdline(){
	for param in $(cat /proc/cmdline); do
		case "${param}" in
			$1=*) echo "${param##*=}"; return 0 ;;
			$1) return 0 ;;
			*) continue ;;
		esac
	done
	[ -n "${2}" ] && echo "${2}"
	return 1
}

get_driver(){
	echo $(kernel_cmdline driver)
}

while [ -e "/var/lib/pacman/db.lck" ];
do
    echo 'Pacman is not ready yet. Will try again in 10 seconds.'
    seconds=$(($seconds + 10))
    sleep 10
    if [[ "$seconds" == "30" ]]; then
        echo 'Warning: removing pacman db.lck!'
        rm /var/lib/pacman/db.lck
    fi
done

# free = remove nvidia keep nouveau
mv /etc/pacman.conf /etc/pacman.conf.bak
mv /etc/pacman_lwd.conf /etc/pacman.conf
pacman -Sy
selection=$(get_driver)
if [[ $selection == "oldnvidia" ]]; then
	pacman -S nvidia-optimus-support nvidia-470xx-support --noconfirm
    echo "blacklist nouveau" > /usr/lib/modprobe.d/nvidia-utils.conf
    modprobe nvidia nvidia_modeset nvidia_uvm nvidia_drm
fi
#freenonouveau = Not nouveau
if [[ $selection == "newnvidia" ]]; then
    echo "blacklist nouveau" > /usr/lib/modprobe.d/nvidia-utils.conf
fi
if [[ $selection == "free" ]]; then
	echo "Nouveau Drivers are already installed, preparing to remove redundant packages related to NVIDIA"
	pacman -Rns nvidia-support nvidia-optimus-support
fi
if [[ $selection == "freenonouveau" ]]; then
	echo "INTEL/AMD Drivers are already installed, blacklisting nouveau and preparing to remove redundant packages related to NVIDIA"
	echo "blacklist nouveau" > /usr/lib/modprobe.d/nvidia-utils.conf
    pacman -Rns nvidia-support nvidia-optimus-support
fi
# Fix pacman
mv /etc/pacman.conf /etc/pacman_lwd.conf
mv /etc/pacman.conf.bak /etc/pacman.conf
#pacman-key --init
#pacman-key --populate archlinux chaotic
#until [[ $? -eq 0 ]]
#do
#pacman-key --init
#pacman-key --populate archlinux chaotic
#done

